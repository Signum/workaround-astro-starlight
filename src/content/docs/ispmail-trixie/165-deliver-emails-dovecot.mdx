---
title: "Deliver emails: Dovecot"
lastUpdated: 2025-08-22
slug: ispmail-trixie/deliver-emails-dovecot
sidebar:
  order: 165
---

import { Aside } from "@astrojs/starlight/components";
import StepListReceive from "../../../components/StepListReceive.astro";

## About LMTP

<StepListReceive currentStep={3} />

As explained in the previous section, Postfix speaks SMTP and receives the email from the internet. Postfix could even
save the email to a mailbox on disk. But instead we will use Dovecot for the final delivery. Actually Dovecot's main
purpose is to let users fetch their email using the IMAP protocol. But it provides additional features we can use as
well.

So we need tell Postfix to hand over the incoming email to Dovecot. The communication between Postfix and Dovecot will
happen using LMTP – the [local mail transfer protocol](https://en.wikipedia.org/wiki/Local_Mail_Transfer_Protocol).
LMTP is a variant of SMTP with fewer features. It is meant for email communication between internal services that trust
each other.

In this chapter we will mainly configure Dovecot so that it knows how to deliver incoming emails.

## Setting up the vmail directory

On your disk all the mailboxes will live in the directory `/var/vmail`. To separate the mailboxes from the rest of your
system, let's create a new user and group that will own the mailboxes:

```sh
groupadd --system vmail
useradd --system --gid vmail vmail
mkdir -p /var/vmail
chown -R vmail:vmail /var/vmail
```

## Dovecot configuration

The configuration files for Dovecot are found in `/etc/dovecot/conf.d`. All these files are loaded by Dovecot. This is
done by this magical line at the end of the `/etc/dovecot/dovecot.conf` file:

```
!include conf.d/*.conf
```

It loads all files in `/etc/dovecot/conf.d/` that end in “.conf” in alphanumerical order. Let's edit a couple of files
for our purpose.

### 10-auth.conf

The `/etc/dovecot/conf.d/10-auth.conf` file is dealing with authentication. At the end of this file you will find a list
of authentication backends that Dovecot ships with. By default it will use system users (those from /etc/passwd). But we
want to use the MariaDB database backend so go ahead and change this block to:

```
#!include auth-system.conf.ext
!include auth-sql.conf.ext
#!include auth-ldap.conf.ext
#!include auth-passwdfile.conf.ext
#!include auth-checkpassword.conf.ext
#!include auth-static.conf.ext
```

Every line starting with `#` is disabled. Only lines starting with `!` are considered.

### 10-mail.conf

Edit this file at `/etc/dovecot/conf.d/10-mail.conf`. It contains many settings regarding mailboxes, like where they are
located, who owns them and what is their layout? Set this:

```
mail_driver = maildir
mail_home = /var/vmail/%{user | domain}/%{user | username}
mail_path = ~/Maildir
```

This looks more sophisticated than with versions of Dovecot before 2.4. What it means:

- **mail_driver**: Mailboxes are stored in
  [maildir](https://doc.dovecot.org/2.4.1/core/config/mailbox_formats/maildir.html#maildir-mailbox-format) format.
- **mail_home**: Every mail user gets their own _home_ directory in `/var/vmail/DOMAIN/USER`. The `user` variable
  contains the email address like `john@example.org`. The expression `user | domain` splits off the _domain_ part from
  the email address. Similarly `user | username` takes the part before the `@` sign.
- **mail_path**: Within the _home_ directory the actual mailbox will live in a subdirectory called `Maildir`. The reason
  is that we will store other data in the user's _home_ directory as well that should not conflict with the mailbox
  directory.

### 10-master.conf

This configuration file at `/etc/dovecot/conf.d/10-master.conf` deals with Dovecot's services.

So most settings are sane here and do not have to be changed. However one change is required in the “service auth”
section because we want Postfix to allow Dovecot as an authentication service. Make it look like this:

```
# Postfix smtp-auth
unix_listener /var/spool/postfix/private/auth {
  mode = 0660
  user = postfix
  group = postfix
}
```

That way Dovecot will put a communication socket into `/var/spool/postfix/private/auth`. It will allow Postfix to
authenticate your users which is relevant later when we set up _relaying_.

### 10-ssl.conf

TODO: verify

Earlier in this guide you created both a key and a certificate file to encrypt the communication with POP3, IMAPs and
HTTPS between the users and your mail server. You need to tell Dovecot where to find these files:

```
ssl\_cert = \</etc/letsencrypt/live/webmail.example.org/fullchain.pem
ssl\_key = \</etc/letsencrypt/live/webmail.example.org/privkey.pem
```

And enforce TLS encryption by setting:

```
ssl = required
```

See the [Dovecot documentation on SSL encryption](https://doc.dovecot.org/admin_manual/ssl/) for more information.

Next let’s take a look at how Dovecot knows about users and their passwords:

### auth-sql.conf.ext

Dovecot reads the `auth-sql.conf.ext` which defines how to find user information in your database. Open the file. There
are two sections:

- userdb: where to find a user’s mailbox in the file system
- passdb: where to find the user’s hashed password

By default Dovecot will run two queries at your database. One for the _userdb_ that gets information like the user ID,
group ID, home directory and quota. And another for the _passdb_ that gets the hashed password.

The “userdb” section already reads:

```
userdb {
   driver = sql
   args = /etc/dovecot/dovecot-sql.conf.ext
}
```

As you can see Dovecot uses an SQL database lookup to get that information. And it refers to the dovecot-sql.conf.ext
file for more information. Let’s see…

## /etc/dovecot/dovecot-sql.conf.ext

(This configuration file is one level up and not in “conf.d”.)

You will find this file well documented although all configuration directives are commented out. Add these lines at the
bottom of the file:

```
driver = mysql

connect = \
  host=127.0.0.1 \
  dbname=mailserver \
  user=mailserver \
  password=x893dNj4stkHy1MKQq0USWBaX4ZZdq

user_query = SELECT email as user, \
  concat('*:bytes=', quota) AS quota_rule, \
  '/var/vmail/%d/%n' AS home, \
  5000 AS uid, 5000 AS gid \
  FROM virtual_users WHERE email='%u'

password_query = SELECT password FROM virtual_users WHERE email='%u'

iterate_query = SELECT email AS user FROM virtual_users
```

<Aside type="tip" title="Backslashes">
  Ending a line with a backslash (\) means that it is continued on the next line. It keeps the configuration more
  readable when it is split over multiple lines.
</Aside>

What these lines mean:

- driver: the kind of database. MariaDB is the same kind as MySQL.
- connect: where to find the MySQL database and how to access it (username, password)
- user_query: an SQL query that returns the user name (=the email address), the quota, the home directory, user ID and
  group ID.
- password_query: this SQL query just gets the password hash from the database
- iterate_query: ‘doveadm’ uses this query to get a list of all users. That allows you to use the “doveadm user ‘\*'”
  command later.

The _user_query_ gets several pieces of information from the database. Let’s look at it one by one:

- email AS user  
   It gets the the _email_ field from the database which corresponds to the user name. Dovecot expects it in the _user_
  field so we set an alias to _“user”._
- userdb_quota_rule  
   This is the user’s quota in bytes. Think of it as the maximum possible space on disk that the user can occupy. As
  [documented](https://doc.dovecot.org/configuration_manual/quota/#per-user-quota) Dovecot expects the quota in a
  special format like “\*:bytes=10000” if the user should not be able to store more than 10,000 bytes. That’s why we
  begin the string with ‘\*:bytes=’.
- userdb_home  
   This leads to the directory where all emails and various control files for this user are located. The placeholder
  ‘%d’ replaces the domain and ‘%n’ the user part. So for John that makes it “/var/vmail/example.org/john”.
- userdb*uid and userdb_gid  
   Those are the user ID and group ID of \_vmail* user – 5000 for both. Dovecot uses it to set the permissions of files
  it creates. As all users share the same system user “vmail” this is just a static number.s

## Fix permissions

Make sure that only root can access the SQL configuration file so nobody else is reading your database access passwords:

```
chown root:root /etc/dovecot/dovecot-sql.conf.ext
chmod go= /etc/dovecot/dovecot-sql.conf.ext
```

Restart Dovecot from the shell:

```
systemctl restart dovecot
```

Look at your /var/log/mail.log logfile. You should see:

```
... Dovecot v2.3.13 (f79e8e7e4) starting up for imap, lmtp, sieve, pop3 (core dumps disabled)
```

If you get any error messages please double-check your configuration files.
